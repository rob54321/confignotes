How to create a debian live system on hdd or usb from scratch.


PARTITION THE USB FLASH DRIVE
a partition for the boot files label live ext4
a partition for the persistence label persistence ext4

In the persistence partition witch is ext4 create the file
persistence.conf 
which contains only one line

/ union


run the make-live script with the correct options.

some fixes are required
copy vesamenu.c32 chroot/usr/lib/syslinux/vesamenu.c32
in the live chroot environment after make-live has been run.

copy isolinux.bin chroot/usr/lib/systelinux/isolinux.bin

The Contents files in the debian repository must be copied to one directory up from where they are.
Could be a bug in live-build.
they should be in /mnt/hdext/debian/dists/sid/Contents-amd64.gz

They are normally in /mnt/hdext/debian/dists/sid/main/Contents-amd64.gz

The build will fail at the end with an error from
/usr/bin/env looking for rsvg.

The filesystem.squashfs and vmlinux and initrd.img are found in live/binary

Mount a usb or hdd partition ext4 in /mnt/hdext/chroot/amd64/sid/boot
mkdir /mnt/hdext/chroot/amd64/sid/boot/live

cp filesystem.squashfs vmlinuz initrd.img /mnt/hdext/chroot/amd64/sid/boot/

rename vmlinuz vmlinuz-4.3.1-amd64
rename initrd.img initrd.img-4.3.1-amd64

they need version numbers to be found by grub.


THE CHROOT ENVIRONMENT TO INSTALL GRUB2

Create a chroot environment to enable grub to be installed
debootstrap sid /mnt/hdext/chroot/amd64/sid file:///mnt/hdext/debian


bind /dev /proc /tmp to the chroot with bindall



chroot /mnt/hdext/chroot/amd64/sid

edit /etc/fstab to
# UNCONFIGURED FSTAB FOR BASE SYSTEM
LABEL=hdext /mnt/hdext ext4 noauto,users,exec 0 0



mount /mnt/hdext for respositories

edit /etc/apt/sources.list to contain

deb file:///mnt/hdext/debian sid main contrib non-free

deb file:///mnt/hdext/mydebian debian main
deb file:///mnt/hdext/mydebian common main


do an apt-get update
It may be necessary to do apt-key add /mnt/hdext/mydebian/keyFile to add the mydebian public key

install grub with
apt-get install grub2 to /dev/sdd 

edit boot/grub/grub.cfg to make sure the boot line looks like

#
# DO NOT EDIT THIS FILE
#
# It is automatically generated by grub-mkconfig using templates
# from /etc/grub.d and settings from /etc/default/grub
#

### BEGIN /etc/grub.d/00_header ###
### END /etc/grub.d/00_header ###

### BEGIN /etc/grub.d/05_debian_theme ###
set menu_color_normal=cyan/blue
set menu_color_highlight=white/blue
### END /etc/grub.d/05_debian_theme ###

### BEGIN /etc/grub.d/10_linux ###
menuentry 'Debian GNU/Linux' --class debian --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-simple-03fd446b-2eb4-47c9-bebb-7b3a0be1bd21' {
	set root='hd0,msdos1'
	echo	'Loading Linux 3.13-1-amd64 ...'
	linux	/vmlinuz-3.13-1-amd64 boot=live persistence config locale=en_ZA timezone=Africa/Johannesburg noprompt quickreboot utc=no hostname=tattyusb username=robert
	echo	'Loading initial ramdisk ...'
	initrd	/initrd.img-3.13-1-amd64
}
### END /etc/grub.d/10_linux ###

Note:
set root='hd0,msdos1' must be checked

grub will have root='hd3,msdos1' since the flash drive is the 3rd or 4th hdd on the system.
it must be hd0 at boot time as it will be the first.

msdos1 is the parttion number. It does not have to be the first partition.

SOME SETTINGS FOR THE LIVE SYSTEM
use nomodeset as a kernel parameter to prevent the fonts being changed.
persistence-media=removable-usb boot parameter does not work with a usb
hard drive. It only works with flash drives. If used with a hard drive the 
persistence partition won't be found.

WINDOWS 10 SETTINGS
to mount a windows 10 disk run a command prompt as administrator
then run
powercfg /H off
this will force windows to do a full shutdown and not hibernate.
The windows disk can now be mounted rw.
