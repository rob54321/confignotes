Notes on how to make an ubuntu live 16.10 system.

1. create the chroot with: 
debootstrap --arch=amd64 yakkety /mnt/hdint/chroot file:///mnt/hdext/ubuntu-archive

2. bind /dev /dev/pts /proc /sys /tmp to the chroot with bindall

3. chroot /mnt/hdint/chroot

4. edit fstab to mount hdext, mount /mnt/hdext

5. copy /etc/apt/sources.list to chroot environment

6. run apt-key add /mnt/hdext/mydebian/keyFile to add mydebian key

7. export LC_ALL=C to avoid error messages

8. mount ubuntu-mate iso image 16.10 and check kernel version in /boot

9. copy casper/initrd.lz casper/vmlinuz.efi from iso image to chroot/boot/casper/

10. mount disk drive in chroot/boot so when grub is run it will be installed
   to the mbr

11. backup boot/grub/grub.cfg if not backed up already.

12. install casper, lupin-casper, os-prober, discover,
   linux-image-2.8.0-22-generic (same version as checked in step 8),
   laptop-detect, ubuntu-standard and any other packages.

13. step 12 will install grub. Replace grub.cfg with the one from the backup.
    grub.cfg at end of file.

14. remove all extra linux kernels and initrd.img files from boot.

15. umount /mnt/hdext, exit the chroot and unbindall

16. mksquasfs /mnt/hdint/chroot filesystem.squashfs -e boot
    to exclude the boot directory.

17. Place filesystem.squashfs in chroot/boot/casper with
    initrd.lz and vmlinuz.efi

18. The persistence partition must be called casper-rw.
    see below for multiboot with multiple persistent files.

19. version 16.10 now used overlayfs. Not necessary to place persistence.conf
    in the root directory of casper-rw containing / union any more (I think)

20. umount all systems and boot.

# How to make multiple persistent files with multiple boot
# images for live ubuntu

1. make directories casper, casper1, casper2 etc on the boot device.

2. install the vmlinuz.efi initrd.lz and filesystemsquashfs in the
   respective casper directories for the different verions of linux.

3. The boot partition must be vfat (fat32) or else the casper-rw
   will not be loaded. This sets a 4G file size on the casper-rw files.

4. In the boot directory (toplevel which is fat32) make directories
   rescue1, rescue2 rescure3 to hold all the casper-rw persistent files.
   rescue1, rescue2 should be matched with casper1, casper2 etc so that
   each casperX has persistent file in rescueX.
   It may be possible to put the casper-rw files in casper1, casper2 etc.

5. In grub each menuentry should look like:
menuentry 'Ubuntu Linux 17.10'  {
	set root='hd0,msdos1'
	echo	'Loading Linux 4.10.0-19-generic ...'
	linux	/casper1/vmlinuz.efi boot=casper
              persistent persistent-path=/gui1710/
              live-media-path=/casper1/ ignore_uuid nomodeset
              locale=en_ZA.UTF-8 timezone=Africa/Johannesburg
              noprompt quickreboot utc=no hostname=live
              username=robert ip=frommedia
	echo	'Loading initial ramdisk ...'
	initrd	/casper1/initrd.lz
}
   where /gui1710/ is the directory where the casper-rw persistent file is.
   The vmlinuz.efi, initrd.lz and filesystems.squashfs are in casper1.
   Full grub.cfg is at bottom of file.

# to make the casper-rw persistent file.
1. Each live boot version must have it's own casper-rw file in
   it's own directory (rescueX for eg) in the boot directory (fat32).

2. The casper-rw file permissions must be 666 with uid=gid=robert.

3. To make the file:
   dd if=/dev/zero of=casper-rw bs=1M count=1024
   mkfs.ext4 -v -F casper-rw

4. to copy files into it mount it.
   mount -t ext4 casper-rw /mnt/directory -o rw

  now a previous persistent file's contents can be copied into casper-rw

5. umount /mnt/directory

# fixing the time and user in the live system.
once booted,
1. set time: timedatectl set-rtc-local 1

2. set zone  timedatectl set-timezone Africa/Johannesburg

3. user robert has uid=gid=999. It should be 1000 to match main system.
   usermod -u 1000 robert
   groupmod -g 1000 robert
  
   If there are processes robert is running delete them.
   kill -l xxxx
4. reboot and check hardware clock in bios.


# grub.cfg
#
# DO NOT EDIT THIS FILE
#
# It is automatically generated by grub-mkconfig using templates
# from /etc/grub.d and settings from /etc/default/grub
#

### BEGIN /etc/grub.d/00_header ###
### END /etc/grub.d/00_header ###

### BEGIN /etc/grub.d/05_debian_theme ###
set menu_color_normal=cyan/blue
set menu_color_highlight=white/blue
### END /etc/grub.d/05_debian_theme ###

### BEGIN /etc/grub.d/10_linux ###
menuentry 'Ubuntu Linux rescue'  {
	set root='hd0,msdos1'
	echo	'Loading Linux 4.10.0-19-generic ...'
	linux	/casper/vmlinuz.efi boot=casper persistent persistent-path=/rescue/ live-media-path=/casper/ ignore_uuid nomodeset locale=en_ZA.UTF-8 timezone=Africa/Johannesburg noprompt quickreboot utc=no hostname=live username=robert ip=frommedia
	echo	'Loading initial ramdisk ...'
	initrd	/casper/initrd.lz
}
menuentry 'Ubuntu Linux 17.10'  {
	set root='hd0,msdos1'
	echo	'Loading Linux 4.10.0-19-generic ...'
	linux	/casper1/vmlinuz.efi boot=casper persistent persistent-path=/gui1710/ live-media-path=/casper1/ ignore_uuid nomodeset locale=en_ZA.UTF-8 timezone=Africa/Johannesburg noprompt quickreboot utc=no hostname=live username=robert ip=frommedia
	echo	'Loading initial ramdisk ...'
	initrd	/casper1/initrd.lz
}
### END /etc/grub.d/10_linux ###

